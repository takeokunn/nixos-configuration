#+STARTUP: fold
* First Installation (X13Gen2)

X13Gen2 uses LUKS encryption with Btrfs and impermanence. Follow these steps for a fresh installation.

** Prerequisites

- NixOS installation USB
- LUKS passphrase (strong, memorable)
- External storage for backups

** Step 1: Backup (if migrating from existing system)

#+begin_src shell
  # Backup /persist directory
  sudo tar -cvzf /tmp/persist-backup.tar.gz -C / persist

  # Backup home directory
  tar -cvzf /tmp/home-backup.tar.gz -C /home take

  # Copy to external storage
  cp /tmp/*.tar.gz /mnt/external/
#+end_src

** Step 2: Boot NixOS Installer USB

#+begin_src shell
  # Set up network
  sudo systemctl start NetworkManager
  nmtui  # Connect to WiFi if needed
#+end_src

** Step 3: Clone Configuration

#+begin_src shell
  nix-shell -p git
  git clone https://github.com/takeokunn/nixos-configuration /tmp/nixos-config
  cd /tmp/nixos-config
#+end_src

** Step 4: Create LUKS Password File

#+begin_src shell
  echo "YOUR_STRONG_PASSPHRASE" > /tmp/luks-password
  chmod 600 /tmp/luks-password
#+end_src

** Step 5: Run Disko (Partitioning & Formatting)

*WARNING*: This will erase all data on the target disk.

#+begin_src shell
  sudo nix --experimental-features "nix-command flakes" run \
    github:nix-community/disko/latest -- \
    --mode destroy,format,mount \
    /tmp/nixos-config/hosts/X13Gen2/disko-config.nix
#+end_src

** Step 6: Install NixOS

#+begin_src shell
  sudo nixos-install --flake /tmp/nixos-config#X13Gen2 --no-root-passwd
#+end_src

** Step 7: Restore Backups (if migrating)

#+begin_src shell
  # Mount backup drive
  sudo mount /dev/sdX1 /mnt/external

  # Restore persist data
  sudo tar -xvzf /mnt/external/persist-backup.tar.gz -C /mnt

  # Restore home data to persist location
  sudo mkdir -p /mnt/persist/home/take
  sudo tar -xvzf /mnt/external/home-backup.tar.gz -C /mnt/persist/home/
#+end_src

** Step 8: Reboot

#+begin_src shell
  sudo reboot
#+end_src

You will be prompted for your LUKS passphrase during boot.

** Post-Installation: TPM2 Enrollment (Optional)

After successful boot with passphrase, enroll TPM2 for auto-unlock:

#+begin_src shell
  # Enroll TPM2 key
  sudo systemd-cryptenroll --wipe-slot=tpm2 \
    --tpm2-device=auto \
    --tpm2-pcrs=0+7 \
    /dev/disk/by-partlabel/cryptroot

  # Test by rebooting - should auto-unlock
  sudo reboot
#+end_src

* Architecture

** Disk Layout (X13Gen2)

#+begin_example
/dev/nvme0n1
├── ESP (1G, vfat) → /boot
└── LUKS encrypted partition
    └── Btrfs filesystem
        ├── @root    → / (ephemeral, recreated on boot)
        ├── @home    → /home
        ├── @nix     → /nix
        ├── @persist → /persist (persistent data)
        ├── @log     → /var/log
        └── @swap    → /.swapvol (8G swapfile)
#+end_example

** Impermanence

The root filesystem is ephemeral. On every boot:
1. Old @root subvolume is moved to @old_roots with timestamp
2. Old roots older than 7 days are automatically deleted
3. Fresh @root subvolume is created

Persistent data is stored in =/persist= and symlinked/bind-mounted:
- System: =/persist/etc=, =/persist/var/lib=
- User: =/persist/home/take=

** Persisted System Directories

| Path | Purpose |
|------+---------|
| /etc/nixos | NixOS configuration |
| /etc/ssh | SSH host keys |
| /etc/NetworkManager/system-connections | WiFi passwords |
| /var/lib/nixos | NixOS state |
| /var/lib/systemd/coredump | Core dumps |
| /var/lib/bluetooth | Bluetooth pairings |
| /var/lib/alsa | Audio settings |
| /var/lib/docker | Docker data |
| /var/lib/libvirt | Virtual machines |
| /var/lib/tailscale | Tailscale state |
| /var/lib/ollama | Ollama models |

** Persisted User Directories

| Path | Purpose |
|------+---------|
| Downloads, Documents, Pictures, Videos, Music | XDG directories |
| ghq, Projects, src | Development |
| .gnupg, .ssh, .password-store | Security (mode 0700) |
| .cargo, .rustup, .npm, .go | Language toolchains |
| .mozilla, .config/chromium | Browser profiles |
| .config/emacs, .local/share/emacs | Emacs |
| .config/niri, .config/waybar, .config/mako | Wayland |
